{% extends "base.html" %}
{% load static %}
{% load invite_extras %}

{% block title %}{{ invite.guest.first_name }} {{ invite.guest.last_name|default:"" }} - Convite Especial{% endblock %}

{% block extra_css %}
<link rel="preload" href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@300;400;700&family=Inter:wght@300;400;500;600&display=swap" as="style">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@300;400;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

<!-- Tailwind CDN fallback for development (useful when npm/build not available) -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Tailwind generated stylesheet (build with: npm run build:css) -->
<link href="{% static 'css/tailwind.css' %}" rel="stylesheet">

<style>
/* Small helper fallbacks not covered by Tailwind utilities */
.splash-slide { background-repeat: no-repeat; background-size: cover; background-position: center; }
.splash-caption { text-shadow: 0 6px 18px rgba(0,0,0,0.6); }
</style>
{% endblock %}

{% block content %}
<div class="invite-container min-h-screen max-w-3xl mx-auto p-6 flex flex-col items-center justify-center">

    <!-- Splash Overlay (always rendered; shows memories if present, otherwise uses fallbacks) -->
    <div id="splashOverlay" class="splash-overlay fixed inset-0 flex items-center justify-center z-50 overflow-hidden" aria-hidden="true" style="display:none; background:transparent;">
        <button id="splashSkipBtn" class="splash-skip absolute top-4 right-5 bg-black/40 text-white px-3 py-2 rounded-full focus:outline-none" aria-label="Pular slideshow">Pular</button>

        <div class="splash-stage relative w-full h-full" id="splashStage">
            {% comment %} Slides will be populated by JS using data-* attributes below {% endcomment %}
            {% if media_data.memories_urls and media_data.memories_urls|length > 0 %}
                {% for url in media_data.memories_urls %}
                    <div class="splash-slide absolute inset-0 bg-cover bg-center opacity-0 transform scale-105 transition-opacity duration-1000" data-src="{{ url }}"></div>
                {% endfor %}
            {% else %}
                {# Fallback: use logo, avatar or default textual slide so splash always shows #}
                {% if media_data.logo_url %}
                    <div class="splash-slide absolute inset-0 bg-cover bg-center opacity-0 transform scale-105 transition-opacity duration-1000" data-src="{{ media_data.logo_url }}"></div>
                {% elif media_data.avatar_url %}
                    <div class="splash-slide absolute inset-0 bg-cover bg-center opacity-0 transform scale-105 transition-opacity duration-1000" data-src="{{ media_data.avatar_url }}"></div>
                {% else %}
                    <div class="splash-slide absolute inset-0 flex items-center justify-center bg-gradient-to-br from-gray-900 to-gray-700" role="img" aria-label="Thalita e Felipe">
                        <div class="splash-caption text-white text-3xl font-serif">Thalita &amp; Felipe</div>
                    </div>
                {% endif %}
            {% endif %}

            <!-- progress dots -->
            <div class="splash-progress absolute bottom-6 left-1/2 transform -translate-x-1/2 flex gap-2" id="splashProgress"></div>

            <!-- loader shown until first image loads (visible only when overlay displayed) -->
            <div id="splashLoader" class="absolute inset-0 flex items-center justify-center" style="display:none;">
                <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-yellow-400 border-gray-200"></div>
            </div>

            <!-- final logo / end frame (hidden until last) -->
            <div class="splash-logo-end absolute inset-0 hidden items-center justify-center flex-col gap-4 text-white" id="splashEnd">
                {% if media_data.logo_url %}
                <img src="{{ media_data.logo_url }}" alt="Logo dos Noivos" class="max-w-xs drop-shadow-lg">
                {% else %}
                <div class="text-3xl font-serif">Thalita &amp; Felipe</div>
                {% endif %}
                <div class="opacity-90 text-center max-w-[70%]">"Assim já não são dois, mas uma só carne." — Mateus 19:6</div>
            </div>
        </div>
    </div>

    <!-- Cabeçalho Principal -->
    <header class="invite-header fade-in bg-white rounded-2xl p-12 mb-8 shadow relative overflow-hidden text-center" id="mainInviteContent" style="opacity:1;">
        <div class="guest-profile mb-6">
            {% if media_data.avatar_url %}
            <img src="{{ media_data.avatar_url }}" 
                 alt="{{ invite.guest.first_name }}" 
                 class="profile-picture w-28 h-28 rounded-full object-cover border-4 border-yellow-400 mx-auto mb-5 shadow-lg"
                 loading="eager">
            {% endif %}
            
            {% if invite.guest.emoji %}
            <div class="guest-emoji text-2xl mt-3">{{ invite.guest.emoji }}</div>
            {% endif %}
        </div>
        
        <h1 class="guest-name font-serif text-4xl text-gray-900 mb-2">
            {{ invite.guest.first_name }} {{ invite.guest.last_name|default:"" }} ("{{ invite.guest.nickname }}")
        </h1>
        
        <div class="personalized-message text-lg italic text-gray-500 max-w-xl mx-auto">
            {{ invite.personalized_message|default:"Temos o prazer de convidá-lo(a) para nosso evento especial!" }}
        </div>
    </header>

    <!-- Vídeo Pré-confirmação -->
    {% if invite.pre_confirmation_video_url %}
    <section class="content-section fade-in bg-white rounded-xl p-8 mb-8 shadow">
        <h2 class="section-title font-serif text-2xl text-yellow-600 mb-6 text-center">Uma Mensagem Especial</h2>
        <div class="video-container relative pb-[56.25%] h-0 overflow-hidden rounded-lg shadow">
            <iframe src="{{ invite.pre_confirmation_video_url|get_video_embed_url }}"
                    allowfullscreen
                    loading="lazy" class="absolute inset-0 w-full h-full border-0 rounded-lg"></iframe>
        </div>
    </section>
    {% endif %}

    <!-- Galeria de Memórias -->
    {% if media_data.memories_urls %}
    <section class="content-section fade-in bg-white rounded-xl p-8 mb-8 shadow">
        {% memory_gallery media_data %}
    </section>
    {% endif %}

    <!-- Formulário RSVP -->
    <section class="content-section fade-in bg-white rounded-xl p-8 mb-8 shadow">
        {% rsvp_form invite %}
    </section>

    <!-- Vídeo de Agradecimento -->
    {% if invite.thank_you_video_url and invite.invitation_status == 'accepted' %}
    <section class="content-section fade-in bg-white rounded-xl p-8 mb-8 shadow">
        <h2 class="section-title font-serif text-2xl text-yellow-600 mb-6 text-center">Mensagem de Agradecimento</h2>
        <div class="video-container relative pb-[56.25%] h-0 overflow-hidden rounded-lg shadow">
            <iframe src="{{ invite.thank_you_video_url|get_video_embed_url }}"
                    allowfullscreen
                    loading="lazy" class="absolute inset-0 w-full h-full border-0 rounded-lg"></iframe>
        </div>
    </section>
    {% endif %}

    <!-- QR Code -->
    {% if invite.qr_code_id %}
    <section class="content-section qr-section fade-in bg-white rounded-xl p-8 mb-8 text-center shadow">
        <h2 class="section-title font-serif text-2xl text-yellow-600 mb-6 text-center">Seu Convite Digital</h2>
        <div class="qr-code-container inline-block p-5 bg-white rounded-lg shadow border border-gray-100">
            <img src="{{ invite.get_qr_code_url }}"
                 alt="QR Code do Convite" 
                 width="200" 
                 height="200"
                 loading="lazy">
        </div>
        <p class="mt-4 text-gray-500">
            Compartilhe este QR Code para mostrar seu convite
        </p>
    </section>
    {% endif %}
</div>

<!-- RSVP Profile Completion Modal (shown after Accept) -->
<div id="rsvpModal" class="rsvp-modal fixed inset-0 hidden items-center justify-center bg-black/60 z-50" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="rsvp-card bg-white p-6 rounded-lg w-full max-w-md shadow" role="document">
        <h3 class="text-lg font-semibold mb-2">Complete o seu perfil</h3>
        <p class="text-sm text-gray-600 mb-4">Obrigado por confirmar! Para completar a sua experiência, preencha algumas informações:</p>
        <label for="dietary" class="block text-sm font-medium text-gray-700">Restrições alimentares</label>
        <input id="dietary" name="dietary" placeholder="Ex: Sem glúten, vegetariano" class="mt-1 block w-full rounded-md border-gray-200 shadow-sm p-2" />

        <label for="music" class="block text-sm font-medium text-gray-700 mt-3">Sugestões musicais</label>
        <input id="music" name="music" placeholder="Música ou artista" class="mt-1 block w-full rounded-md border-gray-200 shadow-sm p-2" />

        <label for="gender" class="block text-sm font-medium text-gray-700 mt-3">Eu sou</label>
        <select id="gender" name="gender" class="mt-1 block w-full rounded-md border-gray-200 shadow-sm p-2">
            <option value="">Prefiro não dizer</option>
            <option value="male">Homem</option>
            <option value="female">Mulher</option>
            <option value="other">Outro</option>
        </select>

        <div id="dressSuggestions" style="margin-top:12px;"></div>

        <div class="rsvp-actions mt-4 flex gap-3 justify-end">
            <button class="btn btn-ghost bg-gray-100 px-4 py-2 rounded" id="rsvpSkip">Pular</button>
            <button class="btn btn-primary bg-yellow-500 text-white px-4 py-2 rounded" id="rsvpSave">Salvar</button>
        </div>
    </div>
</div>

<script>
// Removed immediate-display fallback to avoid a brief black flash.
// Background images are still assigned early, but overlay is shown only when runSlideshow starts.
</script>

{% endblock %}

{% block scripts %}
<script>
// Lazy loading para imagens e splash slideshow control
document.addEventListener('DOMContentLoaded', function() {
    // Intersection Observer para animações
    const observerOptions = { threshold: 0.1, rootMargin: '0px 0px -50px 0px' };
    const observer = new IntersectionObserver(function(entries) {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
            }
        });
    }, observerOptions);

    document.querySelectorAll('.fade-in').forEach(el => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(20px)';
        el.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
        observer.observe(el);
    });

    // Preload critical images
    const criticalImages = document.querySelectorAll('img[loading="eager"]');
    criticalImages.forEach(img => {
        const preloadLink = document.createElement('link');
        preloadLink.rel = 'preload';
        preloadLink.as = 'image';
        preloadLink.href = img.src;
        document.head.appendChild(preloadLink);
    });

    // Performance monitoring (optional)
    if ('performance' in window) {
        window.addEventListener('load', function() {
            if (performance.timing && performance.timing.loadEventEnd) {
                const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
                console.log('Page load time:', loadTime + 'ms');
            }
        });
    }

    // --- Splash slideshow implementation ---
     const splashOverlay = document.getElementById('splashOverlay');
     const hasSplash = !!splashOverlay;

     const slides = Array.from(document.querySelectorAll('.splash-slide'));
     const progress = document.getElementById('splashProgress');
     const endFrame = document.getElementById('splashEnd');
     const mainInvite = document.getElementById('mainInviteContent');

    // Build progress dots (only if splash present)
    if (hasSplash && progress) {
        slides.forEach((s, i) => {
            const dot = document.createElement('div'); dot.className = 'splash-dot';
            if (i === 0) dot.classList.add('active');
            progress.appendChild(dot);
        });
    }

    // Helper: get caption fallback
    function fallbackCaption(index) {
        const guests = ['Thalita & Felipe', 'Nosso amor', 'Momentos juntos', 'A nossa história'];
        const verses = ['"Assim já não são dois, mas uma só carne." — Mateus 19:6'];
        return guests[index] || verses[0] || '';
    }

    // Populate background images and captions (if splash present)
    if (hasSplash) {
        slides.forEach((slide, idx) => {
            const src = slide.getAttribute('data-src');
            const caption = (slide.getAttribute('data-caption') || '').trim() || fallbackCaption(idx);
            if (src && !slide.style.backgroundImage) slide.style.backgroundImage = `url('${src}')`;
            const captionEl = document.createElement('div'); captionEl.className = 'splash-caption';
            captionEl.innerText = caption;
            slide.appendChild(captionEl);
        });
    }

    // Preload images (wait for first image to load before revealing)
    function preloadImages(slides, timeout = 2000) {
        return new Promise(resolve => {
            if (!slides || slides.length === 0) return resolve([]);
            let resolved = false;
            const urls = slides.map(s => s.getAttribute('data-src')).filter(Boolean);
            if (urls.length === 0) return resolve([]);

            // resolve on first load or after timeout
            const onLoad = (url) => {
                if (!resolved) {
                    resolved = true; clearTimers(); resolve([url]);
                }
            };

            const onError = () => {
                if (!resolved) { /* keep waiting for others or timeout */ }
            };

            const timers = [];
            function clearTimers(){ timers.forEach(t => clearTimeout(t)); }

            urls.forEach(u => {
                const img = new Image();
                img.onload = () => onLoad(u);
                img.onerror = onError;
                img.src = u;
            });

            // fallback timeout
            timers.push(setTimeout(() => { if (!resolved) { resolved = true; clearTimers(); resolve([]); } }, timeout));
        });
    }

    // Config: duration per slide (4-6s recommended)
    const SLIDE_DURATION = 5000; // 5s default
    const TRANSITION_BUFFER = 900; // allow time for crossfade

    let current = 0;
    let running = true;

    function showSlide(index) {
        slides.forEach((s, i) => {
            s.classList.toggle('visible', i === index);
        });
        // update dots
        Array.from(progress.children).forEach((d, i) => d.classList.toggle('active', i === index));
    }

    async function runSlideshow() {
        if (!hasSplash) return;

        // Preload first images (or timeout) before showing the overlay to avoid black flash
        await preloadImages(slides, 2500);

        // Now show overlay and start slideshow
        splashOverlay.style.display = 'flex';
        splashOverlay.setAttribute('aria-hidden','false');
        // ensure overlay is transparent then switch to dark at reveal for cinematic effect
        splashOverlay.style.background = 'transparent';

        // reveal first slide then start normal slideshow
        showSlide(0);


        for (let i = 0; i < slides.length; i++) {
            current = i;
            showSlide(i);
            await new Promise(res => setTimeout(res, SLIDE_DURATION));
        }

        // show final logo frame for a short time
        slides.forEach(s => s.classList.remove('visible'));
        if (endFrame) endFrame.style.display = 'flex';
        await new Promise(res => setTimeout(res, 2500));

        // hide overlay with a gentle fade
        if (splashOverlay) {
            splashOverlay.style.transition = 'opacity 0.8s ease';
            splashOverlay.style.opacity = '0';
            setTimeout(() => { splashOverlay.style.display = 'none'; splashOverlay.setAttribute('aria-hidden','true'); }, 900);
        }

        // optionally focus main content
        if (mainInvite) mainInvite.scrollIntoView({behavior:'smooth'});
    }

    // Skip button handler
    const skipBtn = document.getElementById('splashSkipBtn');
    if (skipBtn) {
        skipBtn.addEventListener('click', function(){
            endSlideshowGraceful();
        });
    }

    // Allow Escape to skip
    document.addEventListener('keydown', function(e){ if (e.key === 'Escape') endSlideshowGraceful(); });

    // Start slideshow slightly after DOM ready to ensure images begin loading
    // If user prefers reduced motion, skip the cinematic slideshow and reveal content immediately
    const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    if (prefersReduced) {
        // reveal content immediately
        endSlideshowImmediate();
    } else {
        setTimeout(() => { runSlideshow().catch(e => console.error(e)); }, 300);
    }

    // helper to immediately end the slideshow and reveal content (used by skip)
    function endSlideshowImmediate() {
        if (!splashOverlay) return;
        splashOverlay.style.display = 'none';
        splashOverlay.setAttribute('aria-hidden', 'true');
        if (mainInvite) mainInvite.scrollIntoView({behavior:'auto'});
    }

    function endSlideshowGraceful() {
        if (!splashOverlay) return;
        splashOverlay.style.transition = 'opacity 0.5s ease';
        splashOverlay.style.opacity = '0';
        setTimeout(() => { splashOverlay.style.display = 'none'; splashOverlay.setAttribute('aria-hidden','true'); }, 520);
    }

    // --- RSVP modal flow: intercept accept action if present ---
    // Observe for the rsvp buttons rendered by the RSVP form inclusion tag
    function attachRsvpHooks() {
        // support the existing accept button markup (.accept-btn)
        const acceptBtn = document.querySelector('.accept-btn');
        if (acceptBtn) {
            acceptBtn.addEventListener('click', function(e) {
                // We'll let the form submission/redirect happen; server will signal to open modal on load.
                // But also schedule the modal just in case (non-blocking)
                setTimeout(() => showRsvpModal(), 600);
            });
        }

        // Attach to the RSVP form submit as a fallback
        const rsvpForm = document.getElementById('rsvp-form');
        if (rsvpForm) {
            rsvpForm.addEventListener('submit', function(e) {
                setTimeout(() => showRsvpModal(), 600);
            });
        }
    }

    function showRsvpModal() {
        const modal = document.getElementById('rsvpModal');
        if (!modal) return;
        modal.classList.add('open');
        modal.setAttribute('aria-hidden','false');
        // autofocus first field
        const first = modal.querySelector('input, select, textarea');
        if (first) first.focus();
    }

    // modal UI logic
    const rsvpSkip = document.getElementById('rsvpSkip');
    const rsvpSave = document.getElementById('rsvpSave');
    const rsvpModal = document.getElementById('rsvpModal');
    const genderEl = document.getElementById('gender');
    const dressSuggestions = document.getElementById('dressSuggestions');

    function updateDressSuggestions() {
        const val = genderEl.value;
        let html = '';
        if (val === 'male') {
            html = '<strong>Dress code:</strong> Paleta sugerida para homens: ternos azul-marinho, cinza-chumbo, gravatas em tons terrosos.';
        } else if (val === 'female') {
            html = '<strong>Dress code:</strong> Paleta sugerida para mulheres: vestidos em tons pastéis, dourados e estampas discretas.';
        } else if (val === 'other') {
            html = '<strong>Dress code:</strong> Elegante / formal — escolha o que te fizer sentir especial.';
        } else {
            html = '<strong>Dress code:</strong> Elegante / formal.';
        }
        dressSuggestions.innerHTML = html;
    }

    if (genderEl) genderEl.addEventListener('change', updateDressSuggestions);
    updateDressSuggestions();

    function closeModal() {
        if (!rsvpModal) return;
        rsvpModal.classList.remove('open');
        rsvpModal.setAttribute('aria-hidden','true');
    }

    rsvpSkip && rsvpSkip.addEventListener('click', function(){ closeModal(); });
    rsvpSave && rsvpSave.addEventListener('click', function(){
        // collect fields
        const dietary = document.getElementById('dietary').value;
        const music = document.getElementById('music').value;
        const gender = document.getElementById('gender').value;

        // send via fetch to a simple endpoint if available (assume an endpoint exists at /invitations/{{ invite.pk }}/complete_profile/)
        const url = window.location.pathname.replace(/\/$/, '') + '/complete_profile/';

        // CSRF helper (reads csrftoken cookie)
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }
        const csrftoken = getCookie('csrftoken');

        fetch(url, {
            method: 'POST',
            headers: { 'Content-Type':'application/json', 'X-Requested-With':'XMLHttpRequest', 'X-CSRFToken': csrftoken },
            body: JSON.stringify({ dietary, music, gender })
        }).then(resp => {
            // ignore response for now; close modal
            closeModal();
            // optionally show a small toast or update the page
            console.log('Profile saved');
        }).catch(err => { console.error('Failed to save profile', err); closeModal(); });
    });

    // Auto-open profile modal if server requested it (rendered by Django)
    try {
        const shouldShow = {{ should_show_profile_modal|yesno:"true,false" }};
        if (shouldShow) {
            // Wait until the modal functions are defined
            setTimeout(() => { showRsvpModal(); }, 600);
        }
    } catch (err) {
        // ignore if template var not present
    }

    // attach hooks once rsvp form renders
    setTimeout(attachRsvpHooks, 500);

});
</script>

<script>
// Inline fallback to open profile modal early if server-side requested it.
+(function(){
    try {
        var shouldShow = {{ should_show_profile_modal|yesno:"true,false" }};
        if (shouldShow) {
            var modal = document.getElementById('rsvpModal');
            if (modal) {
                modal.classList.add('open');
                modal.setAttribute('aria-hidden','false');
                var first = modal.querySelector('input, select, textarea');
                if (first) try { first.focus(); } catch(e){}
            }
        }
    } catch(e) { /* ignore */ }
})();
</script>

{% endblock %}
