{% extends "base.html" %}
{% load static %}
{% load invite_extras %}

{% block title %}{{ invite.guest.first_name }} {{ invite.guest.last_name|default:"" }} - Convite Especial{% endblock %}

{% block extra_css %}
<link rel="preload" href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@300;400;700&family=Inter:wght@300;400;500;600&display=swap" as="style">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@300;400;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

<!-- Tailwind CSS -->
<link href="{% static 'css/tailwind.css' %}" rel="stylesheet">

<style>
/* Base styles and utilities */
body {
    font-family: 'Inter', sans-serif;
    background-color: #f8f5f0;
    color: #333;
}

h1, h2, h3, h4, .font-serif {
    font-family: 'Playfair Display', serif;
}

.content-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 1rem;
}

/* Splash screen and slideshow styles */
.splash-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #000;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

.splash-slide {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    opacity: 0;
    transition: opacity 1s ease, transform 1.5s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.splash-slide.visible {
    opacity: 1;
    transform: scale(1);
}

.splash-slide:not(.visible) {
    opacity: 0;
    transform: scale(1.05);
}

.splash-caption {
    color: #fff;
    font-size: 1.8rem;
    text-align: center;
    padding: 1rem;
    background-color: rgba(0, 0, 0, 0.3);
    border-radius: 8px;
    max-width: 80%;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.6);
}

.splash-progress {
    position: absolute;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 0.5rem;
}

.splash-dot {
    width: 0.75rem;
    height: 0.75rem;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.5);
    transition: background-color 0.3s ease;
}

.splash-dot.active {
    background-color: #fff;
}

.splash-skip {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background-color: rgba(0, 0, 0, 0.5);
    color: white;
    border: none;
    border-radius: 9999px;
    padding: 0.5rem 1rem;
    cursor: pointer;
    font-size: 0.875rem;
    z-index: 1010;
    transition: background-color 0.2s ease;
}

.splash-skip:hover {
    background-color: rgba(0, 0, 0, 0.7);
}

/* RSVP Modal */
.rsvp-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.6);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 1rem;
}

.rsvp-modal.open {
    display: flex;
}

.rsvp-card {
    background-color: #fff;
    border-radius: 8px;
    padding: 1.5rem;
    width: 100%;
    max-width: 500px;
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
    max-height: 90vh;
    overflow-y: auto;
}

/* Animations and transitions */
.fade-in {
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.6s ease, transform 0.6s ease;
}

.fade-in.visible {
    opacity: 1;
    transform: translateY(0);
}

/* Main invite content */
.invite-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    min-height: 100vh;
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem 1rem;
}

.invite-header, .content-section {
    width: 100%;
    background-color: #fff;
    border-radius: 1rem;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    text-align: center;
}

.guest-profile {
    margin-bottom: 1.5rem;
}

.profile-picture {
    width: 7rem;
    height: 7rem;
    object-fit: cover;
    border-radius: 50%;
    border: 4px solid #fbbf24;
    margin: 0 auto 1.25rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.guest-name {
    font-size: 2rem;
    color: #1f2937;
    margin-bottom: 0.5rem;
}

.personalized-message {
    font-style: italic;
    color: #6b7280;
    max-width: 36rem;
    margin: 0 auto;
}

/* Form controls */
input, select, textarea {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    margin-top: 0.25rem;
}

/* Buttons */
.btn {
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: 0.375rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-primary {
    background-color: #fbbf24;
    color: #fff;
}

.btn-primary:hover {
    background-color: #f59e0b;
}

.btn-ghost {
    background-color: #f3f4f6;
    color: #374151;
}

.btn-ghost:hover {
    background-color: #e5e7eb;
}
</style>
{% endblock %}

{% block content %}
<!-- Splash Screen Overlay -->
<div id="splashOverlay" class="splash-overlay" aria-hidden="true" style="display:none;">
    <button id="splashSkipBtn" class="splash-skip" aria-label="Pular slideshow">Pular</button>

    <div class="splash-stage relative w-full h-full" id="splashStage">
        <!-- Splash Slides -->
        {% if media_data.memories_urls and media_data.memories_urls|length > 0 %}
            {% for url in media_data.memories_urls %}
                <div class="splash-slide" data-src="{{ url }}"></div>
            {% endfor %}
        {% else %}
            <!-- Fallback: use logo, avatar or default textual slide -->
            {% if media_data.logo_url %}
                <div class="splash-slide" data-src="{{ media_data.logo_url }}"></div>
            {% elif media_data.avatar_url %}
                <div class="splash-slide" data-src="{{ media_data.avatar_url }}"></div>
            {% else %}
                <div class="splash-slide" style="background-color: #1a1a1a;">
                    <div class="splash-caption">Thalita &amp; Felipe</div>
                </div>
            {% endif %}
        {% endif %}

        <!-- Progress dots -->
        <div class="splash-progress" id="splashProgress"></div>

        <!-- Final logo / end frame -->
        <div class="splash-logo-end" id="splashEnd" style="display: none;">
            <div class="flex flex-col items-center justify-center h-full text-white text-center">
                {% if media_data.logo_url %}
                    <img src="{{ media_data.logo_url }}" alt="Logo dos Noivos" class="max-w-xs drop-shadow-lg mb-4">
                {% else %}
                    <div class="text-3xl font-serif mb-4">Thalita &amp; Felipe</div>
                {% endif %}
                <div class="opacity-90 max-w-md px-4">
                    "Assim já não são dois, mas uma só carne." — Mateus 19:6
                </div>
            </div>
        </div>
    </div>
</div>

<div class="invite-container">
    <!-- Cabeçalho Principal -->
    <header class="invite-header fade-in" id="mainInviteContent">
        <div class="guest-profile">
            {% if media_data.avatar_url %}
            <img src="{{ media_data.avatar_url }}" 
                 alt="{{ invite.guest.first_name }}" 
                 class="profile-picture"
                 loading="eager">
            {% endif %}
            
            {% if invite.guest.emoji %}
            <div class="guest-emoji text-2xl mt-3">{{ invite.guest.emoji }}</div>
            {% endif %}
        </div>
        
        <h1 class="guest-name">
            {{ invite.guest.first_name }} {{ invite.guest.last_name|default:"" }}
            {% if invite.guest.nickname %}("{{ invite.guest.nickname }}"){% endif %}
        </h1>
        
        <div class="personalized-message">
            {{ invite.personalized_message|default:"Temos o prazer de convidá-lo(a) para nosso evento especial!" }}
        </div>
    </header>

    <!-- Vídeo Pré-confirmação -->
    {% if invite.pre_confirmation_video_url %}
    <section class="content-section fade-in">
        <h2 class="text-2xl text-yellow-600 mb-6 text-center">Uma Mensagem Especial</h2>
        <div class="relative pb-[56.25%] h-0 overflow-hidden rounded-lg shadow">
            <iframe src="{{ invite.pre_confirmation_video_url|get_video_embed_url }}"
                    allowfullscreen
                    loading="lazy"
                    class="absolute inset-0 w-full h-full border-0 rounded-lg"></iframe>
        </div>
    </section>
    {% endif %}

    <!-- Galeria de Memórias -->
    {% if media_data.memories_urls %}
    <section class="content-section fade-in">
        {% memory_gallery media_data %}
    </section>
    {% endif %}

    <!-- Formulário RSVP -->
    <section class="content-section fade-in">
        {% rsvp_form invite %}
    </section>

    <!-- Vídeo de Agradecimento -->
    {% if invite.thank_you_video_url and invite.invitation_status == 'accepted' %}
    <section class="content-section fade-in">
        <h2 class="text-2xl text-yellow-600 mb-6 text-center">Mensagem de Agradecimento</h2>
        <div class="relative pb-[56.25%] h-0 overflow-hidden rounded-lg shadow">
            <iframe src="{{ invite.thank_you_video_url|get_video_embed_url }}"
                    allowfullscreen
                    loading="lazy"
                    class="absolute inset-0 w-full h-full border-0 rounded-lg"></iframe>
        </div>
    </section>
    {% endif %}

    <!-- QR Code -->
    {% if invite.qr_code_id %}
    <section class="content-section fade-in text-center">
        <h2 class="text-2xl text-yellow-600 mb-6">Seu Convite Digital</h2>
        <div class="inline-block p-5 bg-white rounded-lg shadow border border-gray-100">
            <img src="{{ invite.get_qr_code_url }}"
                 alt="QR Code do Convite" 
                 width="200" 
                 height="200"
                 loading="lazy">
        </div>
        <p class="mt-4 text-gray-500">
            Compartilhe este QR Code para mostrar seu convite
        </p>
    </section>
    {% endif %}
</div>

<!-- RSVP Profile Completion Modal -->
<div id="rsvpModal" class="rsvp-modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="rsvp-card" role="document">
        <h3 class="text-lg font-semibold mb-2">Complete o seu perfil</h3>
        <p class="text-sm text-gray-600 mb-4">Obrigado por confirmar! Para completar a sua experiência, preencha algumas informações:</p>

        <label for="dietary" class="block text-sm font-medium text-gray-700">Restrições alimentares</label>
        <input id="dietary" name="dietary" placeholder="Ex: Sem glúten, vegetariano" class="mt-1 block w-full rounded-md border-gray-200 shadow-sm p-2" />

        <label for="music" class="block text-sm font-medium text-gray-700 mt-3">Sugestões musicais</label>
        <input id="music" name="music" placeholder="Música ou artista" class="mt-1 block w-full rounded-md border-gray-200 shadow-sm p-2" />

        <label for="gender" class="block text-sm font-medium text-gray-700 mt-3">Eu sou</label>
        <select id="gender" name="gender" class="mt-1 block w-full rounded-md border-gray-200 shadow-sm p-2">
            <option value="">Prefiro não dizer</option>
            <option value="male">Homem</option>
            <option value="female">Mulher</option>
            <option value="other">Outro</option>
        </select>

        <div id="dressSuggestions" class="mt-3 p-2 bg-yellow-50 rounded-md text-sm"></div>

        <div class="mt-4 flex gap-3 justify-end">
            <button class="btn btn-ghost" id="rsvpSkip">Pular</button>
            <button class="btn btn-primary" id="rsvpSave">Salvar</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ===== Animation Observer Setup =====
    const observerOptions = { threshold: 0.1, rootMargin: '0px 0px -50px 0px' };
    const observer = new IntersectionObserver(function(entries) {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('visible');
            }
        });
    }, observerOptions);

    // Add all fade-in elements to the observer
    document.querySelectorAll('.fade-in').forEach(el => observer.observe(el));

    // ===== Splash Screen Implementation =====
    const splashOverlay = document.getElementById('splashOverlay');
    const slides = Array.from(document.querySelectorAll('.splash-slide'));
    const progressContainer = document.getElementById('splashProgress');
    const endFrame = document.getElementById('splashEnd');
    const mainInvite = document.getElementById('mainInviteContent');
    const skipBtn = document.getElementById('splashSkipBtn');

    // Configuration
    const SLIDE_DURATION = 5000; // 5 seconds per slide
    let currentSlide = 0;

    // Create progress indicators
    if (progressContainer && slides.length > 0) {
        slides.forEach((_, index) => {
            const dot = document.createElement('div');
            dot.className = 'splash-dot';
            progressContainer.appendChild(dot);
        });
    }

    // Helper function to get caption fallbacks
    function getCaption(index) {
        const captions = [
            'Thalita & Felipe',
            'Nosso amor',
            'Momentos juntos',
            'A nossa história',
            '"Assim já não são dois, mas uma só carne." — Mateus 19:6'
        ];
        return captions[index % captions.length];
    }

    // Set up slides with background images and captions
    slides.forEach((slide, index) => {
        // Set background image
        const imageUrl = slide.getAttribute('data-src');
        if (imageUrl) {
            slide.style.backgroundImage = `url('${imageUrl}')`;
        }

        // Add caption if not already present
        if (!slide.querySelector('.splash-caption')) {
            const caption = document.createElement('div');
            caption.className = 'splash-caption';
            caption.textContent = getCaption(index);
            slide.appendChild(caption);
        }

        // Preload images
        if (imageUrl) {
            const img = new Image();
            img.src = imageUrl;
        }
    });

    // Show a specific slide
    function showSlide(index) {
        // Hide all slides
        slides.forEach(slide => slide.classList.remove('visible'));

        // Show the current slide
        if (slides[index]) {
            slides[index].classList.add('visible');
        }

        // Update progress dots
        const dots = progressContainer.querySelectorAll('.splash-dot');
        dots.forEach((dot, i) => {
            dot.classList.toggle('active', i === index);
        });
    }

    // End the slideshow gracefully
    function endSlideshow() {
        splashOverlay.style.opacity = '0';
        splashOverlay.style.transition = 'opacity 0.8s ease';

        // Hide after transition completes
        setTimeout(() => {
            splashOverlay.style.display = 'none';
            mainInvite.scrollIntoView({behavior: 'smooth'});
        }, 800);
    }

    // Skip button event handler
    if (skipBtn) {
        skipBtn.addEventListener('click', endSlideshow);
    }

    // Escape key to skip
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') endSlideshow();
    });

    // Run the slideshow
    async function runSlideshow() {
        // Make sure splash overlay is fully visible
        splashOverlay.style.display = 'flex';
        splashOverlay.style.opacity = '1';

        // Run through each slide
        for (let i = 0; i < slides.length; i++) {
            currentSlide = i;
            showSlide(i);
            await new Promise(resolve => setTimeout(resolve, SLIDE_DURATION));
        }

        // Show end frame
        slides.forEach(slide => slide.classList.remove('visible'));
        if (endFrame) {
            endFrame.style.display = 'flex';
            await new Promise(resolve => setTimeout(resolve, 2500));
        }

        // End slideshow
        endSlideshow();
    }

    // Check if user prefers reduced motion
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    if (prefersReducedMotion) {
        // Skip slideshow for accessibility
        splashOverlay.style.display = 'none';
    } else {
        // Preload the first image (or wait a short timeout) before showing overlay to avoid black flash
        (function startWhenReady(){
            if (!slides || slides.length === 0) {
                // nothing to show
                splashOverlay.style.display = 'none';
                return;
            }

            const firstSrc = slides[0].getAttribute('data-src');
            if (!firstSrc) {
                // No image source, start immediately
                setTimeout(() => { runSlideshow().catch(() => {}); }, 300);
                return;
            }

            // Wait for the first image to load or timeout after 2500ms
            let loaded = false;
            const img = new Image();
            const timer = setTimeout(() => {
                if (!loaded) {
                    // fallback: start slideshow to avoid blocking forever
                    runSlideshow().catch(() => {});
                }
            }, 2500);

            img.onload = function() {
                loaded = true; clearTimeout(timer);
                // ensure overlay is shown and start
                runSlideshow().catch(() => {});
            };
            img.onerror = function() {
                // on error, start slideshow anyway after timeout
            };
            img.src = firstSrc;
        })();
    }

    // ===== RSVP Modal Functionality =====
    const rsvpModal = document.getElementById('rsvpModal');
    const rsvpSkip = document.getElementById('rsvpSkip');
    const rsvpSave = document.getElementById('rsvpSave');
    const genderSelect = document.getElementById('gender');
    const dressSuggestions = document.getElementById('dressSuggestions');

    // Show RSVP modal
    function showRsvpModal() {
        if (!rsvpModal) return;

        rsvpModal.classList.add('open');
        rsvpModal.setAttribute('aria-hidden', 'false');

        // Focus first input
        const firstInput = rsvpModal.querySelector('input, select');
        if (firstInput) firstInput.focus();
    }

    // Close RSVP modal
    function closeRsvpModal() {
        if (!rsvpModal) return;

        rsvpModal.classList.remove('open');
        rsvpModal.setAttribute('aria-hidden', 'true');
    }

    // Update dress code suggestions based on gender
    function updateDressSuggestions() {
        const gender = genderSelect.value;
        let suggestion = '<strong>Dress code:</strong> Elegante / formal.';

        if (gender === 'male') {
            suggestion = '<strong>Dress code:</strong> Paleta sugerida para homens: ternos azul-marinho, cinza-chumbo, gravatas em tons terrosos.';
        } else if (gender === 'female') {
            suggestion = '<strong>Dress code:</strong> Paleta sugerida para mulheres: vestidos em tons pastéis, dourados e estampas discretas.';
        } else if (gender === 'other') {
            suggestion = '<strong>Dress code:</strong> Elegante / formal — escolha o que te fizer sentir especial.';
        }

        dressSuggestions.innerHTML = suggestion;
    }

    // Add event listeners
    if (genderSelect) {
        genderSelect.addEventListener('change', updateDressSuggestions);
        updateDressSuggestions();
    }

    if (rsvpSkip) rsvpSkip.addEventListener('click', closeRsvpModal);

    if (rsvpSave) {
        rsvpSave.addEventListener('click', function() {
            // Collect fields and post via fetch; errors are silently handled in UI
            const dietary = document.getElementById('dietary').value;
            const music = document.getElementById('music').value;
            const gender = document.getElementById('gender').value;

            const url = window.location.pathname.replace(/\/$/, '') + '/complete_profile/';

            function getCsrfToken() {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; csrftoken=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
                return null;
            }

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({ dietary, music, gender })
            })
            .then(() => { closeRsvpModal(); })
            .catch(() => { closeRsvpModal(); });
        });
    }

    // Auto-open profile modal if server requested it
    try {
        const shouldShowModal = {{ should_show_profile_modal|yesno:"true,false" }};
        if (shouldShowModal) {
            setTimeout(showRsvpModal, 600);
        }
    } catch (err) {
        // Ignore if template variable not present
    }

    // Ensure RSVP form submit disables submit buttons to prevent double submits
    (function(){
        const rsvpForm = document.getElementById('rsvp-form');
        if (!rsvpForm) return;
        rsvpForm.addEventListener('submit', function(e){
            // disable all submit buttons inside the form
            Array.from(rsvpForm.querySelectorAll('button[type="submit"]')).forEach(b => b.disabled = true);
        });
    })();

});
</script>
{% endblock %}
